@startuml the_deep
skinparam classAttributeIconSize 0
skinparam Nodesep 50
skinparam Ranksep 50
skinparam Linetype ortho
skinparam shadowing false
skinparam BackgroundColor transparent
skinparam package<<core>> {
    BackgroundColor HoneyDew
    BorderColor DarkSeaGreen
}
skinparam package<<states>> {
    BackgroundColor PaleGreen
    BorderColor DarkGreen
}
skinparam package<<things>> {
    BackgroundColor LightYellow
    BorderColor Yellow
}
skinparam package<<UI>> {
    BackgroundColor LightCoral
    BorderColor Coral
}
skinparam package<<utilities>> {
    BackgroundColor LightBlue
    BorderColor Blue
}
top to bottom direction

' === Core Runtime ===
package core <<core>> {
class GameManager {
    - is_running: bool
    - screen: pygame.Surface
    - clock: pygame.time.Clock
    - fps: int
    - states: dict[str, BaseState]
    - current_state: BaseState
    + get_events(): void
    + update(dt: float): void
    + transition_states(): void
    + run(): void
}
}

class DataManager {
    - {static} instance: DataManager
    - save_data: dict
    + {static} get_instance(): DataManager
    + load(path: Path): dict
    + save(path: Path): void
    + get(key: str, default=None): Any
    + set(key: str, value: Any): void
}

package states <<states>> {
    abstract class BaseState {
        - screen_size: tuple[int, int]
        - is_done: tuple[bool, None|str]
        - is_quitting: bool
        + {abstract} enter(data: dict = {}): void
        + {abstract} handle_event(event: Event): void
        + {abstract} update(dt: float): void
        + {abstract} draw(surface: Surface): void
        + {abstract} exit(): void
    }

    class StartScreen {
        - buttons: list[Button]
        + enter(data: dict = {}): void
        + handle_event(event: Event): void
        + update(dt: float): void
        + draw(surface: Surface): void
        + exit(): void
        + quit_game(): void
    }

    class UnderwaterState {
        - player: Player
        - camera: Camera
        - map: TileMap
        - button: Button
        - creatures: list[Creature]
        + enter(data: dict = {}): void
        + handle_event(event: Event): void
        + update(dt: float): void
        + draw(surface: Surface): void
        + exit(): void
        + spawn_creatures(): void
        + check_return_point(): bool
        + update_depth(): void
        + trigger_game_over(): void
    }

    class HomebaseState {
        - player: Player
        - map: TileMap
        + enter(data: dict = {}): void
        + handle_event(event: Event): void
        + update(dt: float): void
        + draw(surface: Surface): void
        + exit(): void
    }
}

package things <<things>> {
abstract class Thing {
    - image: pygame.Surface
    - pos: pygame.math.Vector2
    - rect: pygame.Rect
    + update(dt: float): void
    + draw(surface: Surface): void
}

abstract class MovingThing {
    - speed: float
    - velocity: pygame.math.Vector2
    - movement_axis: pygame.math.Vector2
    - is_sprinting: bool
    - sprint_multiplier: float
    + get_input(): void
    + move(dt: float): void
}

abstract class Holdable {
    - range: float
    - cooldown_s: float
    - is_available: bool
    + {abstract} shoot(pos: tuple[int, int]): void
}

class Player {
    - health: int
    - max_health: int
    - oxygen: float
    - max_oxygen: float
    - oxygen_depletion_rate: float
    - depth: float
    - max_depth_limit: float
    - buffer_inventory: List[Item]
    - buffer_inventory_capacity: int
    - holdables: List[Holdable]
    - active_holdable: Holdable
    + update(dt: float): void
    + draw(surface: Surface): void
    + update_oxygen(): void
    + update_depth_damage(): void
    + heal(): void
    + interact(): void
    + revert(): void
}

abstract class Creature {
    - species_id: int
    - species_name: str
    - health: int
    - max_health: int
    - is_alive: bool
    - research_progress: float
    - max_research_progress: float
    - monetary_value: int
    - damage_amount: int
    + {abstract} update(dt: float): void
    + {abstract} draw(surface: Surface): void
    + take_damage(amount: int): void
    + die(): void
}

class CreaturePassive {
    - flee_radius: float
    + update(dt: float): void
    + draw(surface: Surface): void
    + flee_from_player(player: Player): void
}

class CreatureAggressive {
    - attack_radius: float
    + update(dt: float): void
    + draw(surface: Surface): void
    + chase_player(player: Player): void
}

class Item {
    + interact(): void
}

class Weapon {
    - damage: int
    - ammo: int
    + shoot(pos: tuple[int,int]): void
}

class Harpoon {
    - projectile_speed: float
    + shoot(pos: tuple[int,int]): void
}

class ResearchGun {
    - scan_rate: float
    + shoot(pos: tuple[int,int]): void
}
}

package utilities <<utilities>> {
    class TileMap {
        - path: Path
        - visual_layer: pygame.Surface
        - collision_layer: List[List[int]]
        - tile_size: tuple[int, int]
        - map_size: tuple[int, int]
        + load_from_file(path: Path): void
        + get_visual_layer(): pygame.Surface
        + is_tile_solid(x: int, y: int): bool
        + get_tile_at_position(x: float, y: float): tuple
    }

    class PhysicsService {
        - {static} instance: PhysicsService
        + {static} get_instance(): PhysicsService
        + check_tile_collision(entity: MovingThing, tilemap: TileMap): bool
        + solve_collision_movement(entity: MovingThing, tilemap: TileMap): void
    }

    class Camera {
        - offset: pygame.math.Vector2
        - world_size: pygame.Rect
        - map_boundaries: pygame.Rect
        + follow(target_rect: pygame.Rect): void
        + apply(target_rect: pygame.Rect): pygame.Rect
        + clamp_to_boundaries(): void
    }
}

package ui <<UI>> {

abstract class BaseMenu {
    - is_open: bool
    + {abstract} open(): void
    + {abstract} close(): void
    + {abstract} handle_event(event: Event): void
    + {abstract} update(dt: float): void
    + {abstract} draw(surface: Surface): void
}

class HUD {
    - font: pygame.font.Font
    - debug_mode: bool
    + draw(screen: Surface, player: Player): void
    + draw_health(screen: Surface, health: int): void
    + draw_oxygen(screen: Surface, oxygen: float): void
    + draw_depth(screen: Surface, depth: float): void
    + draw_debug_info(screen: Surface, fps: int, coords: tuple): void
}

class Button {
    - color: tuple[int, int, int]
    - hover_color: tuple[int, int, int]
    - size: tuple[int, int]
    - func: callable
    - surface: pygame.Surface
    - rect: pygame.Rect
    - font: pygame.font.Font
    - txt: str
    - font_color: tuple[int, int, int]
    - txt_surf: pygame.Surface
    - txt_rect: pygame.Rect
    - curcolor: tuple[int, int, int]
    + draw(screen: Surface): void
    + mouseover(): void
    + call_back(*args): Any
}

}

' === Relationships ===

GameManager o-down- "*" BaseState : registry

' --- State Inheritance ---
BaseState <|-- StartScreen
BaseState <|-- UnderwaterState
BaseState <|-- HomebaseState

' --- Inheritance ---
Thing <|-- Item
Thing <|-- MovingThing
Thing <|-- Holdable
MovingThing <|-- Player
MovingThing <|-- Creature
Holdable <|-- Weapon
Holdable <|-- Harpoon
Holdable <|-- ResearchGun

Creature <|-- CreaturePassive
Creature <|-- CreatureAggressive

'--- State Relations ---
UnderwaterState o-- Player
HomebaseState o-- Player
StartScreen o-- "*" Button
UnderwaterState o-- Button
Player o-- "*" Holdable : loadout
Player --> Holdable : active

UnderwaterState o-- "*" Creature
UnderwaterState ..> HUD
UnderwaterState o-- TileMap
UnderwaterState o-- Camera
UnderwaterState ..> PhysicsService
HomebaseState o-- TileMap
HomebaseState ..> BaseMenu
HomebaseState ..> DataManager

' --- Utilities dependencies ---
PhysicsService ..> TileMap : checks
PhysicsService ..> MovingThing : checks
DataManager ..> Player

' --- Layout ---
core -[hidden]down-> states
states -[hidden]down-> things
states -[hidden]down-> utilities
states -[hidden]down-> ui

things -[hidden]left-> utilities
ui -[hidden]right-> utilities

Button -[hidden]up-> HUD
@enduml